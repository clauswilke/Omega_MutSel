/* SJS. 
Hyphy inference for an "experimental" dataset. Name of file indicates the mutation scheme.
Perform 6 total inferences, one for each of the following parameterizations: F61, F1x4, F3x4, CF3x4, Fnuc1 (goes w/ F1x4), Fnuc3 (goes w/ F3x4).
*/



global w; global k; global t; // note that we use "global t" (instead of locally estimated for each branch) since all branch lengths are the same in the simulation tree.

LIKELIHOOD_FUNCTION_OUTPUT = 1;
RANDOM_STARTING_PERTURBATIONS = 1;
OPTIMIZATION_PRECSION = 0.00000001;
#include "CF3x4.bf"; // to compute the CF3x4 frequencies
#include "GY94.mdl"; // Basic GY94 rate matrix
#include "fnuc.mdl"; // Custom Fnuc matrices for this run

/* Read in the data */
DataSet	raw_data = ReadDataFile("temp.fasta");

/* Filter the data to find and remove any stop codons*/
DataSetFilter   filt_data = CreateFilter(raw_data,3,"", "","TAA,TAG,TGA");


/* Set up frequencies. Note that these were all hard-coded in when the file was created via the script Omega_MutSel/np_scripts/prefs_to_freqs.py */

F61 = {{0.0425878663474},{0.0199078643132},{0.0206080077075},{0.0410957486733},{0.0211288327264},{0.0101737510099},{0.0102015024614},{0.0211244049354},{0.0281069065528},{0.0113126700256},{0.0135933116374},{0.0233415011914},{0.038607136559},{0.0183427368963},{0.0208081941436},{0.0378467556072},{0.0212454327197},{0.00799840204442},{0.0102324620869},{0.0165134584925},{0.00727186274848},{0.00347178512148},{0.00349349462},{0.00721584392773},{0.0144718989509},{0.00684780307396},{0.00682240822034},{0.0139887873167},{0.0205386820914},{0.00972918740468},{0.0097893064169},{0.0198883449017},{0.0190032600421},{0.00794583686669},{0.00925901840985},{0.0165008466301},{0.0130669480887},{0.00632403196468},{0.00631782177592},{0.0132104311994},{0.012572795276},{0.00617384774217},{0.00622587915583},{0.0128712793025},{0.0193448210618},{0.00925162260606},{0.00926846715473},{0.0191727272757},{0.0136570776602},{0.03037549023},{0.0221599938113},{0.010960463496},{0.0108055448481},{0.0230642639634},{0.00804200517678},{0.00718219624967},{0.017182851242},{0.0429633607131},{0.0156993564494},{0.0205206463864},{0.0325707642958}};

F1x4 = {{0.037367588363},{0.0204382258569},{0.0206300848715},{0.0360963515048},{0.0204382258569},{0.011178700432},{0.0112836378402},{0.0197429220611},{0.0206300848715},{0.0112836378402},{0.0113895603235},{0.0199282540757},{0.0360963515048},{0.0197429220611},{0.0199282540757},{0.0348683618353},{0.0204382258569},{0.011178700432},{0.0112836378402},{0.0197429220611},{0.011178700432},{0.006114197202},{0.00617159278315},{0.0107984035855},{0.0112836378402},{0.00617159278315},{0.00622952715175},{0.0108997710469},{0.0197429220611},{0.0107984035855},{0.0108997710469},{0.0190712723424},{0.0206300848715},{0.0112836378402},{0.0113895603235},{0.0199282540757},{0.0112836378402},{0.00617159278315},{0.00622952715175},{0.0108997710469},{0.0113895603235},{0.00622952715175},{0.00628800536554},{0.0110020900715},{0.0199282540757},{0.0108997710469},{0.0110020900715},{0.019250299404},{0.0197429220611},{0.0348683618353},{0.0197429220611},{0.0107984035855},{0.0108997710469},{0.0190712723424},{0.0108997710469},{0.0110020900715},{0.019250299404},{0.0348683618353},{0.0190712723424},{0.019250299404},{0.0336821480952}};

F3x4 = {{0.035675220653},{0.0183128322366},{0.0182344100227},{0.0382032745233},{0.0244753227002},{0.0125636918383},{0.0125098895363},{0.0262097179792},{0.0243136702555},{0.0124807122786},{0.0124272653253},{0.0260366103541},{0.0443593922569},{0.0227705980131},{0.0226730860234},{0.0475028327522},{0.0169076088239},{0.00867902701785},{0.00864186026479},{0.0181057330441},{0.0115996250193},{0.00595432860953},{0.00592883000691},{0.0124216094776},{0.0115230128428},{0.00591500198703},{0.00588967179532},{0.0123395683309},{0.0210233108084},{0.0107917023874},{0.0107454883894},{0.0225130861001},{0.0175659909532},{0.00901698824865},{0.00897837422257},{0.0188107701193},{0.0120513143089},{0.00618619010983},{0.00615969859186},{0.0129053068343},{0.0119717188549},{0.00614533210901},{0.00611901555987},{0.0128200710061},{0.0218419583344},{0.0112119311773},{0.0111639176066},{0.023389745462},{0.0123371174133},{0.0257370502431},{0.0164887072616},{0.00846399613946},{0.00842775022689},{0.0176571468521},{0.00840809388701},{0.00837208736824},{0.0175405264916},{0.0298843468659},{0.0153402563639},{0.015274563802},{0.0320020419319}};

pos_freqs = {{0.378787190788,0.276930772224,0.323069797689},{0.179519160138,0.189990976698,0.165838441852},{0.186509634552,0.188736141114,0.165128261274},{0.255184014522,0.344342109964,0.345963499185}};
CF3x4_ = BuildCodonFrequencies(CF3x4(pos_freqs, "TAA,TAG,TGA"));


/* Optimize likelihoods for each frequency specification */


////////////// F61 FREQUENCIES //////////////
Model MyModel = (GY94, F61, 1);
UseModel (USE_NO_MODEL);
UseModel(MyModel);
Tree    Tree01 = DATAFILE_TREE;
LikelihoodFunction  LikFn1 = (filt_data, Tree01);
Optimize (paramValues, LikFn1);
fprintf ("f61_hyout.txt", LikFn1);



////////////// F1x4 FREQUENCIES //////////////
global w; global k; global t;
Model MyModel = (GY94, F1x4, 1);
UseModel (USE_NO_MODEL);
UseModel(MyModel);
Tree    Tree01 = DATAFILE_TREE;
LikelihoodFunction  LikFn2 = (filt_data, Tree01);
Optimize (paramValues, LikFn2);
fprintf ("f1x4_hyout.txt", LikFn2);



////////////// F3x4 FREQUENCIES //////////////
global w; global k; global t;
Model MyModel = (GY94, F3x4, 1);
UseModel (USE_NO_MODEL);
UseModel(MyModel);
Tree    Tree01 = DATAFILE_TREE;
LikelihoodFunction  LikFn3 = (filt_data, Tree01);
Optimize (paramValues, LikFn3);
fprintf ("f3x4_hyout.txt", LikFn3);


////////////// CF3x4 FREQUENCIES //////////////
global w; global k; global t;
Model MyModel = (GY94, CF3x4_, 1);
UseModel (USE_NO_MODEL);
UseModel(MyModel);
Tree    Tree01 = DATAFILE_TREE;
LikelihoodFunction  LikFn4 = (filt_data, Tree01);
Optimize (paramValues, LikFn4);
fprintf ("cf3x4_hyout.txt", LikFn4);

////////////// Fnuc_f1x4 //////////////
global w; global k; global t;
Model MyModel = (Fnuc1, F1x4, 0);
UseModel (USE_NO_MODEL);
UseModel(MyModel);
Tree    Tree01 = DATAFILE_TREE;
LikelihoodFunction  LikFn5 = (filt_data, Tree01);
Optimize (paramValues, LikFn5);
fprintf ("fnuc1_hyout.txt", LikFn5);


////////////// Fnuc_f3x4 //////////////
global w; global k; global t;
Model MyModel = (Fnuc3, F3x4, 0);
UseModel (USE_NO_MODEL);
UseModel(MyModel);
Tree    Tree01 = DATAFILE_TREE;
LikelihoodFunction  LikFn6 = (filt_data, Tree01);
Optimize (paramValues, LikFn6);
fprintf ("fnuc3_hyout.txt", LikFn6);
